---
title: "Régression linéaire polynomiale"
author: "Guyliann Engels & Philippe Grosjean"
description: "**SDD II Module 2** Maîtriser la régression linéaire polynomiale."
tutorial:
  id: "B02Lb_reg_poly"
  version: 2.2.0/5
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
BioDataScience2::learnr_setup()
SciViews::R("model", lang = "fr")

# datasets
reddrum <- read("reddrum", package = "UsingR")
reddrum$length <- reddrum$length*0.0254
reddrum <- labelise(reddrum, 
  label = list(length = "Longueur totale", age = "Age"),
  units = list(length = "m"))

lm1 <- lm(data = reddrum, length ~ age)
lm2 <- lm(data = reddrum, length ~ age + I(age^2))
lm3 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3))

lm_poly_coef <- tidy(lm3)
lm_poly_param <- glance(lm3)

#chart(data = reddrum, length ~ age) +
#  geom_point()
```

```{r, echo=FALSE}
BioDataScience2::learnr_banner()
```

```{r, context="server"}
BioDataScience2::learnr_server(input, output, session)
```

------------------------------------------------------------------------

## Objectifs

La première partie de ce module vous a permis de vous familiariser avec la régression linéaire multiple. L'objectif de ce tutoriel est :

-   Maîtriser la régression linéaire polynomiale dans R avec la fonction `lm()`.

## Description des données

Le tableau de données `reddrum` traite de la croissance de *Sciaenops ocellatus* (L., 1766), un poisson da la famille des Scianidae. Sur base des études Porch et Nieland (2002), le tableau comprend des données simulées de la relation de la longueur en fonction de l'âge. Le tambour rouge est un poisson ayant une longueur totale moyenne de 1 mètre adulte. L'individu le plus long recensé mesurait 1.55 mètre et l'individu le plus âgé avait 50 ans. On le retrouve dans l'océan atlantique, le long des côtes est de l'Amérique du Nord et dans le golfe du Mexique.

```{r, echo = TRUE}
SciViews::R("model",lang = "fr") # Configuration du système

# Importation des données
reddrum <- read("reddrum", package = "UsingR")
# Conversion de pouce en mètre
reddrum$length <- reddrum$length*0.0254
# Ajout des labels et unités
reddrum <- labelise(reddrum, 
  label = list(length = "Longueur totale", age = "Age"),
  units = list(length = "m", age = "Année"))

skimr::skim(reddrum)
```

Les données employées sont une simulation basée sur le papier suivant :

-   Porch, Clay & C.A., Wilson & Nieland, David. (2002). A new growth model for red drum (Scianops ocellatus) that accommodates seasonal and ontogenic changes in growth rates. Fishery Bulletin- National Oceanic and Atmospheric Administration. 100. 149-152

## Modélisation

Vous allez modéliser la longueur (m) des poissons en fonction de leur âge. Le graphique ci-dessous vous propose à nouveau le nuage de points correspondant.

```{r, echo=TRUE}
chart(data = reddrum, length ~ age) +
  geom_point()
```

La croissance de ces poissons est particulière. Les juvéniles ont une croissance très rapide et les adultes croient très lentement. La modélisation de cette relation s'annonce une tâche complexe.

```{r reglin_h2, exercise = TRUE}
reddrum_lm1 <- lm(data = ___, ___ ~ ___)
# Résumé du modèle
summary(___)
# Graphique du modèle
chart(___)
```

```{r reglin_h2-hint-1}
reddrum_lm1 <- lm(data = ___, ___ ~ ___)
# Résumé du modèle
summary(reddrum_lm1)
# Graphique du modèle
chart(reddrum_lm1)

#### ATTENTION: Hint suivant = solution !####
```

```{r reglin_h2-solution}
## Solution ##
reddrum_lm1 <- lm(data = reddrum, length ~ age)
# Résumé du modèle
summary(reddrum_lm1)
# Graphique du modèle
chart(reddrum_lm1)
```

```{r reglin_h2-check}
grade_code("Voici notre régression linéaire. Le R^2 est de 0.82. On pourrait penser que ce modèle est très intéressant, si on se limite à cette valeur. Cependant, en visualisant notre droite sur le graphique, on observe un problème d'ajustement du modèle pour les jeunes individus. Interprétez chaque graphique de l'analyse des résidus pour déterminer si la régression linéaire est justifiée ici.")
```

```{r}
chart$residuals(lm1)
```

Réalisez ensuite une **régression linéaire polynomiale d'ordre 2** avec les mêmes variables.

```{r regpoly_h2, exercise=TRUE}
reddrum_lm2 <- lm(data = ___, ___ ~ ___ + ___(___))
# Résumé du modèle
summary(___)
# Graphique du modèle
chart(___)
```

```{r regpoly_h2-hint-1}
reddrum_lm2 <- lm(data = ___, ___ ~ ___ + I(___))
# résumé du modèle
summary(reddrum_lm2)
# Graphique du modèle
chart(reddrum_lm2)

#### ATTENTION: Hint suivant = solution !####
```

```{r regpoly_h2-solution}
## Solution ##
reddrum_lm2 <- lm(data = reddrum, length ~ age + I(age^2))
# résumé du modèle
summary(reddrum_lm2)
# Graphique du modèle
chart(reddrum_lm2)
```

```{r regpoly_h2-check}
grade_code("Voici notre parabole ajustée dans les données... Est-ce mieux que la droite ? Visuellement, on peut observer que notre modèle est meilleur. Cela n'empêche pas d'étudier le résumé du modèle et d'étudier les graphiques de l'analyse des résidus")
```

```{r}
chart$residuals(lm2)
```

Réalisez à présent une **régression linéaire polynomiale d'ordre 3** avec les mêmes variables.

```{r regpoly3_h2, exercise=TRUE}
reddrum_lm3 <- lm(data = ___, ___ ~ ___ + ___(___) + ___(___))
# Résumé du modèle
summary(___)
# Graphique du modèle
chart(___)
```

```{r regpoly3_h2-hint-1}
reddrum_lm3 <- lm(data = ___, ___ ~ ___ + I(___) + ___(___))
# résumé du modèle
summary(reddrum_lm3)
# Graphique du modèle
chart(reddrum_lm3)

#### ATTENTION: Hint suivant = solution !####
```

```{r regpoly3_h2-solution}
## Solution ##
reddrum_lm3 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3))
# résumé du modèle
summary(reddrum_lm3)
# Graphique du modèle
chart(reddrum_lm3)
```

```{r regpoly3_h2-check}
grade_code(" Est-ce mieux que la la régression linéaire ou que la régression linéaire polynomiale d'ordre 2 ? Visuellement, on peut observer que notre modèle semble meilleur. Attention, vous devez toujours étudier le résumé du modèle et étudier les graphiques de l'analyse des résidus")
```

```{r}
chart$residuals(lm3)
```

Étudiez la régression polynomiale d'ordre 3 et répondez aux questions ci-dessous.

```{r qu_regpoly}
quiz(
  question(text = "Quelle est la valeur de l'ordonnée à l'origine pour la régression polynomiale d'ordre 3 ?",
    answer(sprintf("%.4f", lm_poly_coef$estimate[1]), correct = TRUE),
    answer(sprintf("%.4f", lm_poly_coef$estimate[2])),
    answer(sprintf("%.4f", lm_poly_coef$std.error[1])),
    answer(sprintf("%.4f", lm_poly_coef$std.error[2])),
    answer(sprintf("%.4f", lm_poly_coef$statistic[1])),
    answer(sprintf("%.4f", lm_poly_coef$statistic[2])),
    answer(sprintf("%.4f", lm_poly_param$r.squared[1])),
    allow_retry = TRUE, random_answer_order = TRUE
    ),
  question(text = "Quelle est la part de la variance exprimée par ce modèle ?",
    answer(sprintf("%.3f", lm_poly_coef$estimate[1])),
    answer(sprintf("%.3f", lm_poly_coef$estimate[2])),
    answer(sprintf("%.3f", lm_poly_coef$std.error[1])),
    answer(sprintf("%.3f", lm_poly_param$r.squared[1])),
    answer(sprintf("%.3f", lm_poly_coef$statistic[1])),
    answer(sprintf("%.3f", lm_poly_coef$statistic[2])),
    answer(sprintf("%.3f", lm_poly_param$adj.r.squared[1]), correct = TRUE),
    allow_retry = TRUE, random_answer_order = TRUE
    )
)
```

## Etude complémentaire

Nous avons pu observer que notre modèle s'ajustait de mieux en mieux en augmentant l'ordre de notre polynôme. Une méthode consiste à augmenter l'ordre du polynôme de manière itérative jusqu'à ce que les variables du modèle ne soient plus significatives. Nous ne détaillons pas chaque modèle. Voici le polynome d'ordre 6.

```{r, echo = TRUE}
reddrum_lm6 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3) + I(age^4) + I(age^5) + I(age^6))
summary(reddrum_lm6)
chart(reddrum_lm6)
```

Tous les termes du modèle sont significatifs au seuil alpha de 5%. La valeur de R^2^ atteint 0.94 alors qu'elle n'était que de 0.82 pour la régression linéaire simple. Les graphiques de l'analyse des résidus sont ci-dessous.

```{r}
chart$residuals(reddrum_lm6)
```

```{r, echo = TRUE}
reddrum_lm7 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3) + I(age^4) + I(age^5) + I(age^6) + + I(age^7))
summary(reddrum_lm7)
chart(reddrum_lm7)
```

Jusqu'à la régression polynomiale d'ordre 7, toutes les variables de nos modèles successifs sont significatives au seuil alpha de 5%. À partir de ce dernier, nous avons franchi la limite. Les variables du modèle ne sont plus significatives. Le meilleur modèle polynomial est le polynôme d'ordre 6.

Poussons notre réflexion encore un peu plus loin. Si nous calculons une régression polynomiale d'ordre n-1. La courbe va s'adapter parfaitement à la distribution de nos observations. La valeur de R^2^ sera de 1. Ce modèle ne sera d'aucune utilité. Nous seront dans un cas de surajustement. Il ne contient plus aucune information pertinente.

Voici une analyse de la régression linéaire simple à la régression polynomiale d'ordre 9.

```{r, echo=TRUE}
# Création successive des modèles
lm1 <- lm(data = reddrum, length ~ age)
lm2 <- lm(data = reddrum, length ~ age + I(age^2))
lm3 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3))
lm4 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3) + I(age^4))
lm5 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3) + I(age^4) + I(age^5))
lm6 <- lm(data = reddrum, length ~ age + I(age^2) + I(age^3) + I(age^4) + I(age^5) + I(age^6))
lm7 <- lm(data = reddrum, 
  length ~ age + I(age^2) + I(age^3) + I(age^4) + I(age^5) + I(age^6) + I(age^7))
lm8 <- lm(data = reddrum,
  length ~ age + I(age^2) + I(age^3) + I(age^4) + I(age^5) + I(age^6) + I(age^7) + I(age^8))
lm9 <- lm(data = reddrum,
  length ~ age + I(age^2) + I(age^3) + I(age^4) + I(age^5) + I(age^6) + I(age^7) + I(age^8) + I(age^9))
```

Nous pouvons extraire les paramètres du modèle avec la fonction glance() et le fonction rmse().

```{r, echo=TRUE}
# Combinaison des modèles dans un liste
models <- list(lm1, lm2, lm3, lm4, lm5, lm6, lm7, lm8, lm9)
names(models) <- c("lm", paste0("poly_", 2:9))

# Extraction en série des paramètres du modèle grâce à la fonction glance().
models %>.%
  purrr::map_dfr(., glance) -> mod_params
mod_params$rmse <- purrr::map_dbl(models, rmse, data = reddrum)
mod_params$model <- names(models)

mod_params[ , c("model", "adj.r.squared", "rmse")]
```

> Le chunk ci-dessus mérite une petite explication. Nous avons neuf modèles. Tous ces modèles sont regroupés dans une liste nommée `models`. La fonction glance() et la fonction rmse() vous permettent d'extraire les paramètres d'un modèle. Ici, nous souhaitons extraire en série ces paramètres. Les fonctions map() du package {purrr} vont exécuter une fonction à chaque élément d'une liste ou d'un vecteur. Grâce à ces fonctions, on obtient un tableau `mod_params` qui comprend tous les paramètres des neuf modèles.

```{r}
a <- chart(data = mod_params, adj.r.squared ~ model) +
  geom_line(group=1) +
  geom_point()

b <- chart(data = mod_params, rmse ~ model) +
  geom_line(group=1) +
  geom_point()

combine_charts(list(a,b), ncol = 1)
```

Les graphiques ci-dessus nous montrent les variations du R^2^ (A) et de l'erreur quadratique moyenne (B). On observe un gain de performance des modèles jusqu'au modèle polynomial d'ordre 5 ou 6. Ensuite, ces gains deviennent quasi nuls.

**La visualisation du modèle, l'étude du résumé du modèle, l'analyse des résidus et l'étude des indicateurs de performances forment un tout. Vous devez maîtriser l'ensemble des outils pour valider la pertinence d'un modèle et ensuite comparer des modèles entre eux.**

## Conclusion

Vous venez de terminer ce tutoriel sur la régression polynomiale. La régression polynomiale d'ordre 6 nous a permis de proposer un modèle qui s'ajuste correctement à la croissance des tambours rouges. Vous devez cependant être très vigilant au surajustement.

```{r comm_noscore, echo=FALSE}
question_text(
  "Laissez-nous vos impressions sur ce learnr",
  answer("", TRUE, message = "Pas de commentaires... C'est bien aussi."),
  incorrect = "Vos commentaires sont enregistrés.",
  placeholder = "Entrez vos commentaires ici...",
  allow_retry = TRUE,
  submit_button = "Soumettre une réponse", 
  try_again_button = "Resoumettre une réponse"
)
```
