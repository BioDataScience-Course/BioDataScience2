---
title: "sdd2-mod06 : SOM"
description: "Utilisation des cartes auto-adaptatives (SOM)"
author: "Guyliann Engels & Philippe Grosjean"
output:
  learnr::tutorial
tutorial:
  id: "sdd2.06c"
  version: 1.0.0
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
# Packages ----
library(learnr)
library(knitr)
SciViews::R()
library(BioDataScience)
library(ade4)
library(kohonen)

# Collect informations ------
options(tutorial.event_recorder = BioDataScience::record_sdd)
tutorial_options(exercise.checker = BioDataScience::checker_sdd)
tutorial_options(exercise.timelimit = 60)
tutorial_options(exercise.cap = "Code R")
knitr::opts_chunk$set(echo = FALSE, comment = NA)

# Preparation dataset ------
data("doubs")
enviro <- doubs$env
```

```{r, echo=FALSE}
fixedRow(
  column(9, div(
    img(src = 'images/BioDataScience-128.png', align = "left"),
    h1("Science des données biologiques 2"),
    "Réalisé par le service d'Écologie numérique des Milieux aquatiques, Université de Mons (Belgique)"
  )),
  column(3, div(
    textInput("user", "Utilisateur :", ""),
    textInput("email", "Email :", "")
  ))
)
textOutput("user") # This is newer shown, but required to trigger an event!
textOutput("email") # Idem!
```

```{r, context="server"}
output$user <- renderText({BioDataScience::user_name(input$user);""})
output$email <- renderText({BioDataScience::user_email(input$email);""})
updateTextInput(session, "user", value = BioDataScience::user_name())
updateTextInput(session, "email", value = BioDataScience::user_email())
```

## Préambule

Si vous n'avez jamais utilisé de tutoriel "learnr", familiarisez-vous d'abord avec son interface [ici](http://biodatascience-course.sciviews.org/sdd-umons/learnr.html).

![](images/attention.jpg)

**Ne vous trompez pas dans votre adresse mail et votre identifiant Github**

**N'oubliez pas de soumettre votre réponse après chaque exercice**

> Conformément au RGPD ([Règlement Général sur la Protection des Données](https://ec.europa.eu/info/law/law-topic/data-protection/reform/rules-business-and-organisations/principles-gdpr_fr)), nous sommes tenus de vous informer de ce que vos résultats seront collecté afin de suivre votre progression. **Les données seront enregistrées au nom de l'utilisateur apparaissant en haut de cette page. Corrigez si nécessaire !** En utilisant ce tutoriel, vous marquez expressément votre accord pour que ces données puissent être collectées par vos enseignants et utilisées pour vous aider et vous évaluer. Après avoir été anonymisées, ces données pourront également servir à des études globales dans un cadre scientifique et/ou éducatif uniquement.

## Contexte 

Des scientifiques ont réalisé des mesures d'abondance d'espèces de poissons et des mesures physico-chimiques sur 30 stations différentes.

L'objet `doubs` du package `ade4` est une liste qui contient 4 jeux de donnnées. Nous nous intéresserons aux données portant sur les mesures environnementales.

```{r}
data(doubs, package = "ade4")
class(doubs)
```

Ce tableau comprend 30 sites d'échantillonages avec 11 mesures environnementales.

```{r}
enviro <- doubs$env
```

Voici une courte description des variables étudiées (en anglais). Ces informations proviennent de la page d'aide `?ade4::doubs`

- dfs : distance from the source (km * 10), 
- alt : altitude (m), 
- slo : (log(x + 1) where x is the slope (per mil * 100), 
- flo : minimum average stream flow (m3/s * 100), 
- pH : pH,
- har : total hardness of water (mg/l of Calcium), 
- pho : phosphates (mg/l * 100), 
- nit : nitrates (mg/l * 100), 
- amm : ammonia nitrogen (mg/l * 100), 
- oxy : dissolved oxygen (mg/l * 10), 
- bdo : biological demand for oxygen (mg/l * 10)

```{r, echo=TRUE}
summary(enviro)
```

## Cartes auto-adaptatives (SOM)

La fonction som() du package kohonen ne peut employer qu'une matrice. Commencez par centrer et transfomez `enviro` en une matrice.

```{r, echo = TRUE, eval = FALSE}
# function de base
DF %>.%
  scale(.) %>.%
  as.matrix(.) -> MATRIX

som. <- som(MATRIX, grid = somgrid(X, Y, topo = "hexagonal"))
# un premier graphique de diagnostic est le nombre d'observation pour 
plot(som., type = "mapping", shape = "straight")
```

```{r som, exercise = TRUE}
summary(enviro)
```

```{r som-hint-1}
# function de base
DF %>.%
  scale(.) %>.%
  as.matrix(.) -> MATRIX

som. <- som(MATRIX, grid = somgrid(X, Y, topo = "hexagonal"))
# un premier graphique de diagnostic est le nombre d'observation pour 
plot(som., type = "mapping", shape = "straight")
```

```{r som-hint-2}
# function de base
enviro %>.%
  scale(.) %>.%
  as.matrix(.) -> envi_mat

som. <- som(envi_mat, grid = somgrid(3, 3, topo = "hexagonal"))
# un premier graphique de diagnostic est le nombre d'observation pour 
plot(som., type = "mapping", shape = "straight")
```

```{r som-check}
# TODO
```

```{r qu_som}
question("Selon vous quelle est la grille la plus adpatée afin de représenter les données provenant d `enviro` ?",
           answer("Une grille 2 sur 1"),
           answer("Une grille 3 sur 3", correct = TRUE),
           answer("Une grille 5 sur 6"),
          allow_retry = TRUE)
```

## Exploration graphique de som

Utilisez à nouveau le jeu de données `enviro`. 

- Réalisez une grille 3 sur 3
- Réalisez un graphique de type = "codes"

```{r, echo = TRUE, eval = FALSE}
# function de base
DF %>.%
  scale(.) %>.%
  as.matrix(.) -> MATRIX

som. <- som(MATRIX, grid = somgrid(X, Y, topo = "hexagonal"))
# un premier graphique de diagnostic est le nombre d'observation pour 
plot(som., type = "mapping", shape = "straight")
plot(som., type = "codes", 
     codeRendering = "segments", shape = "straight")
plot(zoo_som, type = "changes", shape = "straight")
```

```{r som1, exercise = TRUE}
summary(enviro)
```

```{r som1-hint-1}
DF %>.%
  scale(.) %>.%
  as.matrix(.) -> MATRIX

som. <- som(MATRIX, grid = somgrid(X, Y, topo = "hexagonal"))
# un premier graphique de diagnostic est le nombre d'observation pour 
plot(som., type = "mapping", shape = "straight")
plot(som., type = "codes", 
     codeRendering = "segments", shape = "straight")
plot(zoo_som, type = "changes", shape = "straight")
```

```{r som1-hint-2}
DF %>.%
  scale(.) %>.%
  as.matrix(.) -> MATRIX

som. <- som(MATRIX, grid = somgrid(X, Y, topo = "hexagonal"))
# un premier graphique de diagnostic est le nombre d'observation pour 
plot(som., type = "codes", 
     codeRendering = "segments", shape = "straight")
```

```{r som1-hint-3}
enviro %>.%
  scale(.) %>.%
  as.matrix(.) -> enviro_mat

som. <- som(enviro_mat, grid = somgrid(3, 3, topo = "hexagonal"))
# un premier graphique de diagnostic est le nombre d'observation pour 
plot(som., type = "codes", 
     codeRendering = "segments", shape = "straight")
```

```{r som1-check}
# TODO
```

Après avoir réalisé ce graphiques, tentez de l'analyser. 

## Conclusion

Vous venez de terminer votre séance d'exercice.

Laissez nous vos impressions sur cet outil pédagogique ou expérimentez encore dans la zone ci-dessous. Rappelez-vous que pour placer un commentaire dans une zone de code R, vous devez utilisez un dièse (`#`) devant vos phrases.

```{r comm, exercise=TRUE, exercise.lines = 8}
# Ajout de commentaires 
# ...
```

```{r comm-check}
# Not yet...
```
